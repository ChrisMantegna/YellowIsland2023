---
title: "Initial Data Visualization " 
author: Chris 
date: "`r format(Sys.time(), '%d %B, %Y')`"\
output: 
  html_document: 
  theme: readable 
  highlight: zenburn 
    toc: true 
    toc_float: true 
    number_sections: true 
    code_folding: show 
    code_download: true 
editor: 
markdown: 
wrap: 72 
---

###READ ME
We will use the following files to explore our data

algae.csv - the algal presence/ absence by top layer and second layer
percentCover.csv - the substrate and second layer information
truncated.csv - this is a simplified version of species data

Note: Add parameters block/ explanation of choices on render
What I did - will chronicle as things work
OLD csv: presence.csv - Presence/ Absence data of seaweeds (may collapse this further, but it is here as a relic)
OLD csv: data.csv - Full data set without manipulation

# Package Install and call
```{r}

# Installation is commented out, remove hashtag if you need to install
#install.packages("kableExtra")
#install.packages('gridExtra')

```

```{r}

#Use library to call your installed packages for use
library(data.table)
library(dplyr)
library('ggplot2')
library("indicspecies")
library(kableExtra)
library(knitr)
library(RColorBrewer)
library(tidyr)
library(tidyverse)
library(vegan)

```

# Working directory & data load
```{r}

getwd()

```

```{r}
#You can also hover over the file on your 'files pane' and right click to import data
#change this path/ place to you and your file path
setwd("/home/shared/8TB_HDD_02/cnmntgna/GitHub/YellowIsland2023/data")

counts<- read.csv("truncated.csv", header= TRUE) #species counts per section
algae<- read.csv("algae.csv", header= TRUE) #algal cover in first and second layer of each quadrat
substrate<- read.csv("substrate.csv", header=TRUE) #substrate percent cover in first and second layer of each quadrat

```

# At-a-Glance data frame check
# counts
```{r}

#shows the dimensions of your data frame, a quick check to make sure everything imported the way you like
dim(counts)

#quick view of data frame structure
str(counts)

#look at the summary of your data
summary(counts)

```
# algae
```{r}

#repeat the process for the second dataframe. Make Note that our data here is characters and will have to change to a number so we can manipulate it.
dim(algae)

str(algae)

summary(algae)

```

# substrate
```{r}

#repeat the process for the second dataframe. Make Note that our data here is characters and will have to change to a number so we can manipulate it.
dim(substrate)

str(substrate)

summary(substrate)

```

# Change dataframe structures so we can work with the data
## counts
```{r}

#trying to apply the section1 test code to create a stacked bar for species presence across the sections.
counts1 <- counts %>%
  gather(key = "Species", value = "Count", ANNELIDA:OSTEICHTHYES)

```

```{r}
# this counts the categories from above so i can plot them
counts2 <- counts1 %>%
  group_by(SECTION, ZONATION, Species, Count) %>%
  tally()
```

```{r}

# plot the species counts
ggplot(counts2, aes(x = Species, y = n, fill = Count)) +
  geom_bar(stat = "identity") +
  labs(title = "Species Count by Section",
       x = "Species",
       y = "Count",
       fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~SECTION, ncol = 2)

```
# Species Richness
## How many different species are present in different sections on YI?
### Note 'species' is a misleading name because these aren't all species, some are phyla. This will be corrected
```{r}
# total island richness is 28 unique species present (non-algal) 
species_richness <- length(unique(counts2$Species))

print(species_richness)
```
# Clarifying species/ phyla by site and zonation
```{r}

#this is grouped by zone, not by section

zonation <- counts2 %>%
  group_by(ZONATION, Species) %>%
  summarize(Sum_Count = sum(Count))

```

```{r}

#this is grouped by zone and section
section_zone <- counts2 %>%
  group_by(SECTION, ZONATION, Species) %>%
  summarize(Sum_Count = sum(Count))

```

# Heatmap
## counts
```{r}

# Convert ZONATION to a factor with ordered levels
section_zone$ZONATION <- factor(section_zone$ZONATION, levels = c("L", "M", "U"))

# Create a new data frame with required columns for the heatmap
heatmap_data <- section_zone %>%
  select(Species, ZONATION, Sum_Count)

# Plot the heatmap
ggplot(data = heatmap_data, aes(x = ZONATION, y = Species, fill = Sum_Count)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "Heatmap of Species Counts by Zonation and Species",
       x = "Zonation", y = "Species", fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

# Stacked Bar plot
## counts
```{r}
# we will have to choose zone over section or vice versa so we can clearly see the result. Maybe we adjust the way we manipulate it

# Plot the stacked bar plot with sections on X-axis and species on Y-axis
ggplot(data = section_zone, aes(x = factor(SECTION), y = Sum_Count, fill = Species)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Stacked Bar Plot of Species Counts by Section and Species",
       x = "Section", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

# NMDS 
# Not going to use this plot type - I just wanted to try it out to see if it is helpful
```{r}

# Check for missing values in the entire data frame
sum(is.na(counts))

# Check for missing values in specific columns (e.g., the algal count columns)
colSums(is.na(counts[, 3:13]))

# Convert the species count data to a distance matrix
distance_matrix <- vegdist(counts[, 3:13], method = "bray")

# Impute missing values with the mean of non-missing values
distance_matrix[is.na(distance_matrix)] <- mean(distance_matrix, na.rm = TRUE)

# Perform NMDS
nmds_result <- metaMDS(distance_matrix, k = 2)  # k = 2 for 2-dimensional NMDS, you can change it as needed

# Plot NMDS
plot(nmds_result, display = "sites", type = "n")  # Plot without points first
points(nmds_result, display = "sites", pch = 16, col = counts$SECTION)  # Add points with different colors for sections
legend("bottomright", legend = unique(counts$SECTION), col = unique(counts$SECTION), pch = 16, title = "Section")

```

# PERMANOVA - this is glitchy - use the ANOVA
## counts
```{r}

# Convert the species count data to a distance matrix
distance_matrix <- vegdist(counts[, 3:13], method = "bray")

# Impute missing values with the mean of non-missing values
distance_matrix[is.na(distance_matrix)] <- mean(distance_matrix, na.rm = TRUE)

# Perform PERMANOVA
permanova_result <- adonis(distance_matrix ~ SECTION, data = counts)

# Print PERMANOVA results
print(permanova_result)

```
# ANOVA
# counts
```{r}
library(stats)

# Combine the columns related to species counts into a single column
species_data <- counts %>%
  select(SECTION, ZONATION, starts_with("ANNELIDA"), starts_with("BRYOZOA"), starts_with("TUNICATA"),
         starts_with("PORIFERA_DEMOSPONGIAE"), starts_with("CNIDAIRA_ANTHOZOA"),
         starts_with("MOLLUSCA"), starts_with("ARTHROPODA_NC"), starts_with("ARTHROPODA_C"),
         starts_with("ECHINODERMATA_A"), starts_with("ECHINODERMATA_O"), starts_with("OSTEICHTHYES"))

# Gather the species count data into a long format
species_data_long <- species_data %>%
  pivot_longer(cols = starts_with("ANNELIDA"):starts_with("OSTEICHTHYES"),
               names_to = "Species", values_to = "Count")

# Calculate the total count of each species for each section and zone
total_counts <- species_data_long %>%
  group_by(SECTION, ZONATION, Species) %>%
  summarise(Total_Count = sum(Count))

# Create a Poisson GLM for section comparison
section_glm <- glm(Total_Count ~ SECTION, data = total_counts, family = poisson)

# Create a Poisson GLM for zone comparison
zone_glm <- glm(Total_Count ~ ZONATION, data = total_counts, family = poisson)

# Perform ANOVA on the Poisson GLMs
section_anova <- anova(section_glm)
zone_anova <- anova(zone_glm)

# Print the ANOVA results
print(section_anova)
print(zone_anova)

```
### The explanation here is that SECTION has a small deviance and a low degree of freedom meaning the model is a good fit for this data and SECTION has a significant effect on species count. Additionally, the small degree of freedom for ZONATION also indicates a significant effect on species count - this we knew. 

# ANOVA
## algae
```{r}

# Sum the counts for each species to get the total count per section and zone
section_totals <- algae %>%
  group_by(SECTION) %>%
  summarise(total_count = sum(BROWN_FL, RED_FL, GREEN_FL, ENCRUSTING_FL, OTHER_FL,
                              BROWN_SL, RED_SL, GREEN_SL, ENCRUSTING_SL, OTHER_SL))

zone_totals <- algae %>%
  group_by(ZONATION) %>%
  summarise(total_count = sum(BROWN_FL, RED_FL, GREEN_FL, ENCRUSTING_FL, OTHER_FL,
                              BROWN_SL, RED_SL, GREEN_SL, ENCRUSTING_SL, OTHER_SL))

# Create a Poisson GLM for section comparison
section_glm <- glm(total_count ~ SECTION, data = section_totals, family = poisson)

# Create a Poisson GLM for zone comparison
zone_glm <- glm(total_count ~ ZONATION, data = zone_totals, family = poisson)

# Perform ANOVA on the Poisson GLM
section_anova <- anova(section_glm)
zone_anova <- anova(zone_glm)

# Print the ANOVA results
print(section_anova)
print(zone_anova)

```



# Stacked bar
## algae
```{r}
# this visualization is unhelpful - trying to break it down below
# Create a new data frame with the right categories for viz

plot_data <- algae %>%
  gather(key = "Algal_Type", value = "Count", starts_with("BROWN_"), factor_key = TRUE) %>%
  mutate(Algal_Type = gsub("_FL|_SL", "", Algal_Type),
         ZONATION = factor(ZONATION, levels = c("L", "M", "U")))

# Plot the stacked bar plot
ggplot(data = plot_data, aes(x = factor(SECTION), y = Count, fill = ZONATION)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Algal Counts by Section, Algal Type, and Zone",
       x = "Section", y = "Count", fill = "Zone") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
# Algal profile by zone and section
```{r}

# Create a new data frame with the relevant columns for visualization
plot_data_by_section <- algae %>%
  gather(key = "Algal_Type", value = "Count", starts_with(c("BROWN_", "RED_", "GREEN_", "ENCRUSTING_", "OTHER_")), factor_key = TRUE) %>%
  mutate(Algal_Type = gsub("_FL|_SL", "", Algal_Type))

plot_data_by_zone <- algae %>%
  gather(key = "Algal_Type", value = "Count", starts_with(c("BROWN_", "RED_", "GREEN_", "ENCRUSTING_", "OTHER_")), factor_key = TRUE) %>%
  mutate(Algal_Type = gsub("_FL|_SL", "", Algal_Type),
         ZONATION = factor(ZONATION, levels = c("L", "M", "U")))

# Create two separate plots for each algal type
# 1. Algal type by section
plot_section <- ggplot(data = plot_data_by_section, aes(x = factor(SECTION), y = Count, fill = Algal_Type)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Algal Type Distribution by Section",
       x = "Section", y = "Count", fill = "Algal Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 2. Algal type by zone
plot_zone <- ggplot(data = plot_data_by_zone, aes(x = Algal_Type, y = Count, fill = ZONATION)) +
  geom_bar(stat = "identity", position = "stack") +
  labs(title = "Algal Type Distribution by Zone",
       x = "Algal Type", y = "Count", fill = "Zone") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Arrange the plots side by side using 'gridExtra' package
library(gridExtra)

# Arrange the two plots side by side
grid.arrange(plot_section, plot_zone, ncol = 2)

```



# Trying a PCA
```{r}
# This is a plot that shows 3 dimensions of data in 2 dimensions
# Create a species abundance matrix

species_matrix <- t(table(counts1$species, counts1$SECTION))

# Run PCA

pca_result <- rda(species_matrix)

# Create a PCA plot in base R - do this first and then do it in ggplot

plot(pca_result, type = "points", display = "species", cex = 1.5)

# Load required libraries

# install.packages("ggplot2") # If not installed previously library(ggplot2)

# Extract PCA scores for each species

pca_scores <- scores(pca_result, display = "species")

# Convert PCA scores to a data frame

pca_data <- as.data.frame(pca_scores$species)

# Add Species names as a column

pca_data$Species <- rownames(pca_data)

# Create a PCA plot using ggplot2

ggplot(pca_data, aes(x = PC1, y = PC2, label = Species)) + geom_point() + geom_text(size = 3, hjust = 0, vjust = 0) + xlab("Principal Component 1") + ylab("Principal Component 2") + ggtitle("PCA Plot of Intertidal Species") + theme_minimal()
```




# Trying Presence/ Absence Data Manipulation

```{r}

#different data pivot; using the full sheet

data_long <- data %>%
  gather(key = "Seaweed", value = "Presence", FL_ROCKWEED:FL_OTHER)

```

```{r}

seaweed_counts <- data_long %>%
  group_by(SECTION, Seaweed, Presence) %>%
  tally()

```


```{r}

ggplot(seaweed_counts, aes(x = Seaweed, y = n, fill = Presence)) +
  geom_bar(stat = "identity") +
  labs(title = "Presence/Absence of Seaweeds",
       x = "Seaweed Species",
       y = "Count",
       fill = "Presence") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~SECTION, ncol = 2)

```
```{R}
#section1 test data to show zonation v substrate - have to alter this to make that happen

test_long <- data %>%
  pivot_longer(cols = c(BARNACLE, ROCK, ALGAE),
               names_to = "substrate",
               values_to = "percent")

# Printing the first few rows of the resulting data frame
print(data_long)
```

# Next plot
```{r}

```




